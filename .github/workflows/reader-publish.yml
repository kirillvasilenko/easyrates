name: reader-publish

env:
  SERVICE_FOLDER: scr/Reader/EasyRates.ReaderApp.AspNet
  SERVICE_NAME: easyrate-reader
  VERSION_TAG_PREFIX: reader

on:
  pull_request:
    branches:
      - master
    paths:
      - "src/Model/**"
      - "src/Reader/**"
      - ".github/workflows/reader-build.yml"
  push:
    branches:
      - master
    paths:
      - "src/Model/**"
      - "src/Reader/**"
      - ".github/workflows/reader-build.yml"

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v2
    - name: Setup .NET Core
      uses: actions/setup-dotnet@v1
      with:
        dotnet-version: 3.1.102
    - name: local publish
      run: dotnet publish -c Release ${SERVICE_FOLDER}
    - name: extract service version
      run: |
        SVC_VERSION=$(git describe --match "$VERSION_TAG_PREFIX*")
        SVC_VERSION=$(echo $SVC_VERSION | cut -d'/' -f 2)
    - name: build docker image
      run: docker build  -t "${SERVICE_NAME}" -f "${SERVICE_FOLDER}/Dockerfile" "${SERVICE_FOLDER}"
    - name: login in docker.pkg.github.com
      run: docker login -u ${GITHUB_ACTOR} -p ${{secrets.GITHUB_TOKEN}} docker.pkg.github.com
    - name: tag docker images
      run: |
        docker tag "${SERVICE_NAME}" docker.pkg.github.com/${GITHUB_REPOSITORY,,}/${SERVICE_NAME}:latest
        docker tag "${SERVICE_NAME}" docker.pkg.github.com/${GITHUB_REPOSITORY,,}/${SERVICE_NAME}:$SVC_VERSION
    - name: publish to docker.pkg.github.com
      run: |
        docker push docker.pkg.github.com/${GITHUB_REPOSITORY,,}/${SERVICE_NAME}:latest
        docker push docker.pkg.github.com/${GITHUB_REPOSITORY,,}/${SERVICE_NAME}:$SVC_VERSION
      
